{% extends 'base.html.twig' %}
{% set now = "now"|date("Y-m-d H:i:s") %}
{% set createdAt = projet.createdAt|date("Y-m-d H:i:s") %}
{% set interval = (now|date('U') - createdAt|date('U'))|abs %}

{% set days = interval // 86400 %}
{% set months = days // 30 %}
{% set remainingDays = days % 30 %}

{% block pageBannerurlretour %}
                <li><a href="{{path('app_projects', { 'cat': projet.categorie.id ,'page': 1}) }}">{{projet.categorie.name}}</a></li>
                <li>{{ title }}</li>
 {% endblock %}
{% block body %} 
        <section class="blog_section ">
            <div class="container">
              <div class="row">
                <div class="col-lg-8 position-relative">
                 <div class="blog_image">
                    <img
                    {# {% set url='uploads/pub_pictures/'~publication.image %} 
                    src="{{ asset(url)  }}"  #}
                     src="{{asset('assets/images/gallery/' ~ random(1,5) ~ '.png')}}"
                    alt="HelpMeBalance"
                    style="width: 1200px; height: 400px; "
                    />
                    <div class="d-flex justify-content-end">
                    <a class="btn btn-primary" href="{{ path('add_project') }}">
                    <span class="btn_text" data-text="Maintenant">
                        Faire un Don
                    </span>
                    <span class="btn_icon">
                        <i class="fa-regular fa-circle-dollar-to-slot"></i>
                    </span>
                    </a>
                    </div>
                </div>
                
                <div class="details_content" style="margin-top: 50px;">
                    <ul class="post_meta unordered_list mb-4">
                        <li>
                             {{ projet.user.lastName|capitalize }} {{ projet.user.firstName|capitalize }}
                        </li>
                        <li>
                            {{ projet.createdAt ? projet.createdAt|date('j F Y H:i:s') : '' }} <i class="fa-regular fa-calendar-days"></i>
                        </li>
                    </ul>                    
                    <div class="container my-5">
                        <div class="details_header text-center mb-4">
                            <h2 class="item_title">{{ projet.name }} <i class="fa-duotone fa-solid fa-bars-progress"></i></h2>
                            <p >
                                <strong class="text-secondary" ><i class="fa-solid fa-calendar-alt"></i> Lancé :</strong>
                                {% if months > 0 %}
                                    {{ ' il y a ' ~ months ~ ' mois' ~ (remainingDays > 0 ? ', ' ~ remainingDays ~ ' jours' : '') }}
                                        {% elseif days > 0 %}
                                    {{ ' il y a ' ~ days ~ ' jour' ~ (days > 1 ? 's' : '') }}
                                        {% else %}
                                            {{ ' aujourd\'hui' }}
                                        {% endif %}
                            </p>
                        </div>                        
                        <div class="row"  >
                            <!-- Left Column: General Info -->
                            <div class="col-md-6">                               
                                <div class="card mb-3" style="border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div class="card-body">
                                        <h5><i class="fas fa-tags"></i> Type de Projet</h5>
                                        <p>{{ projet.type|capitalize }}</p>
                                    </div>
                                </div>                               
                            </div>
                            <!-- Right Column: Description and Progress Bar -->
                            <div class="col-md-6">
                                <div class="card mb-3"style="border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div class="card-body">
                                        <h5><i class="fas fa-info-circle"></i> Status du Projet</h5>
                                        <p>{{ projet.status|capitalize }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                             <div class="col-md-12">
                                <div class="card mb-3"style="border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div class="card-body text-center">
                                     <h5><i class="fas fa-align-left"></i> Description</h5>
                                        <p>{{ projet.description|capitalize }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card mb-3" style="border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div class="card-body text-center" >
                                        <h5><i class="fas fa-money-bill-wave"></i> Progression du Financement</h5>
                                        <p>{{ projet.currentFunding }} <i class="fa-solid fa-hexagon-vertical-nft"></i> collectés sur {{ projet.price }} <i class="fa-solid fa-hexagon-vertical-nft"></i></p>
                                        <div class="progress" style="height: 25px; background-color: #f2f2f2; border-radius: 5px; box-shadow: inset 0 1px 3px rgba(0,0,0,.2);">
                                            <div class="progress-bar" role="progressbar" 
                                                style="width: {{ (projet.currentFunding / projet.price) * 100 }}%; 
                                                    background-color: #646aa4; 
                                                    font-weight: bold;
                                                    font-size: 16px;
                                                    color: white;
                                                    line-height: 25px; 
                                                    text-align: center;
                                                    border-radius: 5px;">
                                                {{ ((projet.currentFunding / projet.price) * 100) | number_format(1) }}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>  
                            <div class="blog_image" id="map{{ projet.id }}" style="width: 100%; height:400px;position: relative; left: 50%; transform: translateX(-50%); margin-top: 20px;">
                            </div>             
                                <script>
                                    document.addEventListener("DOMContentLoaded", function() {
                                        var latitude = {{ projet.latitude }};
                                        var longitude = {{ projet.longitude }};
                                        var projectName = "{{ projet.name }}"; 

                                        var map = L.map('map{{ projet.id }}').setView([latitude, longitude], 15);
                                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                            maxZoom: 19,
                                            attribution: '© OpenStreetMap'
                                        }).addTo(map);

                                        var marker = L.marker([latitude, longitude]).addTo(map)
                                            .bindPopup(`<a class="btn btn-primary" href="{{ path('add_project') }}">
                    <span class="btn_text" data-text="{{projet.name}}">
                        Faire un Don
                    </span>
                    <span class="btn_icon">
                        <i class="fa-regular fa-circle-dollar-to-slot"></i>
                    </span>
                    </a>`, { offset: L.point(0, -20) });
                                        marker.openPopup();

                                        // Event listener for zoom changes
                                        map.on('zoomend', function() {
                                            // Recenter the map after zooming
                                            map.setView([latitude, longitude], map.getZoom());
                                        });
                                    });
                                </script>
                       
                    </div>
                </div>    
                </div>
                <div class="col-lg-4">
                  <aside class="sidebar ps-lg-4">                  
                    {% if is_granted('IS_AUTHENTICATED_REMEMBERED')  %}
                   <div class="form-group">
                      <input
                        id="sidebar_search"
                        class="form-control"
                        type="search"
                        name="search"
                        placeholder=" Créer Votre Projet "
                        disabled
                      />        
                      <a class="btn-link input_icon" href="{{ path('add_project') }}">
                       <br> <i class="fa-solid fa-location-plus fa-xl"></i>
                      </a>            
                    </div>
                    {% else %}
                    <div class="form-group d-flex items-align-center">
                      <input
                        id="sidebar_search"
                        class="form-control"
                        type="search"
                        name="search"
                        placeholder="Se connecter pour créer un projet"
                        disabled
                      />        
                      <a class="btn-link input_icon" href="{{ path('app_user_login')}}">
                        <i class="fa-solid fa-right-to-bracket"></i>
                      </a>            
                    </div>
                    {% endif %}
                    <div class="sidebar_widget">
                      <h3 class="sidebar_widget_title">
                        <span class="title_icon">
                          <img
                            src="{{asset('assets/images/site_logo/favourite_icon.svg')}}"
                            alt="help me balance"
                          />
                        </span>
                        <span class="title_text">Catégories</span>
                      </h3>
                      <ul class="post_category_list unordered_list_block">
                        {% set sortedCategories = categories|sort((a, b) => (a.investments|length) < (b.investments|length)) %}
                        {% for categorie in sortedCategories %}
                        <li>
                          <a href="{{ path('app_projects', { 'cat': categorie.id ,'page': 1}) }}">
                            <span class="category_name">{% if categorie.id == projet.categorie.id %}<mark>{{categorie.name }}</mark>{% else %}{{categorie.name }} {% endif %}</span>                     
                            {% if categorie.investments|length == 0 %}
                            <span class="category_counter">Nouvelle</span>
                            {% else %}
                            <span class="category_counter">{{ categorie.investments|length }}</span>
                            {% endif %}
                          </a>
                        </li>
                        {% endfor %}
                      </ul>
                    </div>
                    <div class="sidebar_widget">
                      <h3 class="sidebar_widget_title">
                        <span class="title_icon">
                          <img
                            src="{{asset('assets/images/site_logo/favourite_icon.svg')}}"
                            alt="help me balance"
                          />
                        </span>
                        <span class="title_text">Découvrir les projets à succès</span>
                      </h3>
                      <ul class="reecommended_post_group unordered_list_block">
                        {% for projet in reccprojets|slice(0, 3) %}
                        <li>
                          <div class="blog_item_small">
                            <div class="blog_image">
                              <a class="blog_image_wrap" href="{{path('project_detail', {'id': projet.id})}}">
                                <img
                                 src="{{asset('assets/images/gallery/' ~ random(1,5) ~ '.png')}}"
                                alt="HelpMeBalance"
                                />
                              </a>
                            </div>
                            <div class="blog_content">
                              <h3 class="item_title">
                                <a href="{{path('project_detail', {'id': projet.id})}}">
                                    {{ projet.name }}
                                </a>
                              </h3>
                             <ul class="post_meta unordered_list" style="display: flex; justify-content: space-between; align-items: center; white-space: nowrap;">
                            <li style="flex: 1;">{{ projet.type }} <i class="fa-solid fa-list-check"></i></li>                          
                            <li style="flex: 2; display: flex; align-items: center; white-space: nowrap; ">
                                <progress style="flex-shrink: 1; min-width: 100px; max-width: 200px; width: 100%;  " 
                                          value="{{ projet.currentFunding }}" 
                                          max="{{ projet.price }}">
                                    {{ projet.currentFunding }}%
                                </progress>
                                <span style="margin-left: 10px;">
                                    {{ projet.currentFunding }} / {{ projet.price }} <i class="fa-solid fa-money-bill-trend-up"></i>
                                </span>
                            </li>
                        </ul>

                            </div>
                          </div>
                        </li>
                        {% endfor %}
                      </ul>
                    </div>
                    
                  </aside>
                </div>
            </div>
            </div>
          </section>

          
{% endblock %}